2022.7.23.24

周末再也躺在家的周末

做了好多梦

但是因为睡得时候太长了

都记不清什么梦了

---------

---------------

周末的几天

安静的躺在床上

原来美好的东西真的在梦里

--------

-------------

周末在家玩英雄联盟

突然发现了一个很简单的英雄

厄加特

他可以自动攻击

所以不用怎么操作也有伤害

哈哈哈哈

周末玩了几把拿了好几次MVP

------

--------

2022.7.25

```
//Map syncArg=Fx.json.parse("{\"objectData\":{\"objAPIName\":\"object_tkC51__c\",\"masterFieldVal\":{\"owner\":\"4106\",\"field_Wloz5__c\":\"2022-04-21\",\"name\":\"FH22042006\",\"address\":\"浙江省杭州市临安区临安市经济开发区南环路88号浙江万马电缆股份有限公司万马股份\",\"province\":\"259\",\"city\":\"369\",\"district\":\"1482\",\"field_ou120__c\":\"51631\",\"field_6aXp7__c\":\"测试客户\",\"tel\":\"13588888880\",\"field_8rcq2__c\":\"财务联系人7\",\"field_G4Hlj__c\":\"13588888881\",\"field_b422k__c\":\"13588888880\",\"field_ukr5x__c\":\"13588888882\",\"field_9W97v__c\":\"收货联系人7\",\"field_e9aal__c\":\"13588888883\",\"field_z1C0G__c\":\"接收发票人7\",\"field_2eoqz__c\":\"13588888884\",\"field_u482J__c\":\"1\",\"account_no\":\"R20210715-008\",\"tenant_id\":\"724968\",\"object_describe_api_name\":\"AccountObjErp\",\"_id\":\"60efedfc203578000112d290\",\"ssbk2\":1,\"ssbk5\":1,\"ssbk8\":1,\"sgpl2\":1,\"sgpl6\":1,\"sgpl7\":1,\"title\":\"客户申请-测试用户7\"},\"detailFieldVals\":{\"object_eyUri__c\": [ { \"field_UeO64__c\": \"12345678\", \"field_z4qql__c\": \"000010\", \"field_Dq97B__c\": \"YJ-10_本1\", \"field_vb4Zq__c\": \"1111.000\", \"field_Wloz5__c\": \"2022-04-24\",  \"name\": \"序号\", \"record_type\": \"业务类型\"},{ \"field_UeO64__c\": \"6218889b2b7691000114c001\", \"field_z4qql__c\": \"000010\", \"field_Dq97B__c\": \"YJ-10_本\", \"field_vb4Zq__c\": \"10.000\", \"field_Wloz5__c\": \"2022-04-22\",  \"name\": \"序号1\", \"record_type\": \"业务类型\"} ] }}}")
//1.判断是否为加急需求
	
//Map  syncArg = Fx.json.parse("{\"objectData\":{\"objAPIName\":\"object_fhxq\",\"masterFieldVal\":{\"name\":\"FH22042418\",\"owner\":\"TES\",\"field_6aXp7__c\":\"测试呃呃二\",\"object_describe_api_name\":\"object_fhxq\",\"tenant_id\":\"724968\",\"_id\":\"6264b4b1d28a1100013812b7\"},\"detailFieldVals\":{\"object_fhxqmx\":[{\"name\":\"242635\",\"mid\":\"6264b4b1d28a1100013812b7\",\"field_UeO64__c\":\"D227583\",\"field_Dq97B__c\":\"WMC-6902T_904200150000A_RD0002\",\"field_vb4Zq__c\":\"10.000\",\"field_Wloz5__c\":\"2022-04-27\",\"object_describe_api_name\":\"object_fhxqmx\",\"tenant_id\":\"724968\",\"_id\":\"6264b4c3d28a1100013818ff\",\"owner\":[\"1001\"],\"created_by\":[]}]}}}")
//Map  syncArg = Fx.json.parse("{\"objectData\":{\"objAPIName\":\"object_fhxq\",\"masterFieldVal\":{\"name\":\"FH22051826\",\"owner\":\"1002\",\"field_6aXp7__c\":\"天津六0九电缆有限公司（删除）\",\"field_2UEyD__c\":\"FH22051826\",\"object_describe_api_name\":\"object_fhxq\",\"tenant_id\":\"724968\",\"_id\":\"6264b4b1d28a1100013812b7\"},\"detailFieldVals\":{\"object_fhxqmx\":[{\"tenant_id\":\"724968\", \"lock_rule\":\"default_lock_rule\", \"field_z4qql__c\":\"000020\", \"field_fxmgm__c\":\"0.000\", \"field_H5808__c__r\":\"22051377552\", \"field_H5808__c\":\"627e1d805be4980001465d67\", \"field_58e4G__c\":\"10.000\", \"field_UeO64__c__r\":\"D229087\", \"field_h1XsB__c__r\":\"000000001200000944\", \"field_UeO64__c\":\"627e1d805be4980001465d66\", \"object_describe_api_name\":\"object_eyUri__c\", \"field_Wloz5__c\":\"2022-05-18\", \"field_X5718__c\":\"62835484d8773b000161fac8\", \"field_yA3cD__c\":\"0.01\", \"field_091mM__c\":\"修改明细数据\", \"field_xSFO1__c\":\"6.840\", \"lock_status\":\"0\", \"field_9yK3J__c\":\"2022-05-17 15:53\", \"life_status\":\"normal\", \"field_6P5mj__c\":\"0010042803\", \"field_h1XsB__c\":\"61748d98753cd300014bae4c\", \"field_kk4ll__c\":\"616fed0e9449630001f5056f\", \"field_kk4ll__c__r\":\"天津六0九电缆有限公司（删除）\", \"field_Dq97B__c\":\"YJG-3_101C_本\", \"record_type\":\"default__c\", \"field_7T8Ql__c\":\"\", \"field_9FAMO__c\":\"\", \"field_d8R01__c\":\"3.16\", \"field_1bgjT__c\":\"\", \"order_by\":\"10\", \"_id\":\"62835484d8773b000161fac9\", \"field_vb4Zq__c\":\"0.01\", \"field_C31rS__c\":\"03\"}, {\"tenant_id\":\"724968\", \"lock_rule\":\"default_lock_rule\", \"field_z4qql__c\":\"000010\", \"field_fxmgm__c\":\"0.000\", \"field_H5808__c__r\":\"22051377553\", \"field_H5808__c\":\"627e1d805be4980001465d68\", \"field_58e4G__c\":\"5.000\", \"field_UeO64__c__r\":\"D229087\", \"field_h1XsB__c__r\":\"000000001200014916\", \"field_UeO64__c\":\"627e1d805be4980001465d66\", \"object_describe_api_name\":\"object_eyUri__c\", \"field_Wloz5__c\":\"2022-05-18\", \"field_X5718__c\":\"62835484d8773b000161fac8\", \"field_yA3cD__c\":\"0.01\", \"field_091mM__c\":\"修改明细数据\", \"field_xSFO1__c\":\"4.690\", \"lock_status\":\"0\", \"field_9yK3J__c\":\"2022-05-17 15:53\", \"life_status\":\"normal\", \"field_6P5mj__c\":\"0010042803\", \"field_h1XsB__c\":\"617739c30d52d500019593e2\", \"field_kk4ll__c\":\"616fed0e9449630001f5056f\", \"field_kk4ll__c__r\":\"天津六0九电缆有限公司（删除）\", \"field_Dq97B__c\":\"WMC-1701O_754200251000_BK0001\", \"record_type\":\"default__c\", \"field_7T8Ql__c\":\"\", \"field_9FAMO__c\":\"\", \"field_d8R01__c\":\"0.31\", \"field_1bgjT__c\":\"\", \"order_by\":\"20\", \"_id\":\"62835484d8773b000161faca\", \"field_vb4Zq__c\":\"0.01\", \"field_C31rS__c\":\"03\"}]}}}")
//获取提交数据syncArg
log.info("syncArg :" + syncArg)
//获取当前时间

Date now = Date.now()
Time time = Time.now()
//OA测试服
//String url = "http://gfzcrmtest.wanmaco.com/crmd/oaService/oaServiceTest?_APP_=m&_SK_=4b5b55ba23c422d9ab5b8649e27fb955"
//OA正式服
String url = "http://crmdadmin.wanmagroup.com/crmd/oaService/oaService?_APP_=m&_SK_=4b5b55ba23c422d9ab5b8649e27fb955"
Map objData = syncArg["objectData"]
Map details = syncArg["detailFieldVals"]
//获取到提交的参数
Map masterFieldVal = objData["masterFieldVal"]
String reqid = ""
String fh = ""
// if(masterFieldVal["field_2UEyD__c"] != null){
//  reqid = masterFieldVal["field_2UEyD__c"]
//  fh = reqid.replace("FH",  "TEST")
// }
//明细id
List Ids=[]
List detailField=objData["detailFieldVals"]["object_fhxqmx"] as List
//log.info("<detailField> = " + detailField)
List list = [];
List sapList = [];
String user = masterFieldVal["owner"]
//销售订单加物料号
Map mat = [:]
//明细id
Map mxid = [:]
//遍历明细
detailField.eachWithIndex { item ,int i->
  Map itemp=item as Map
  String jjTime = item["field_Wloz5__c"]
  String matvbeln = item["field_6P5mj__c"] as String 
  String matposnr = item["field_z4qql__c"] as String
 
  Map sapItem = [:]
  mat.put(matvbeln.concat(matposnr),  item["field_Dq97B__c"])
  mxid.put(matvbeln.concat(matposnr),  item["name"])
  sapItem.put("pmkey",  "")
  sapItem.put("lfimg",  item["field_vb4Zq__c"]) //请求数量
  String edate = item["field_Wloz5__c"]
  sapItem.put("edatu", edate) //请求日期
  log.info("请求日期 = " + item["field_Wloz5__c"])
  sapItem.put("sqr",  user) //业务员
  sapItem.put("reqid","" )
  sapItem.put("status",  "")
  sapItem.put("vbeln", item["field_6P5mj__c"]) //销售订单号
  sapItem.put("posnr", item["field_z4qql__c"]) //行号
  sapItem.put("fksm", "") 
  String bz = "";
  if(item["field_091mM__c"] != null){
    bz = item["field_091mM__c"]
  }
  sapItem.put("jjbj", "") //
  sapItem.put("sqbz",  bz) //行备注
  
  sapList.add(sapItem)
  //明细id
  Ids.add(item["name"])
  
}

//log.info("mxid = " + mxid)
//log.info("sapList = " + sapList)
String cus_name = masterFieldVal["field_6aXp7__c"]
//log.info("cus_name" +cus_name)
String id22 = ""

log.info("details = " + detailField[0]["field_6P5mj__c"])
if(cus_name != null && cus_name != ""){
  
  //=============sap校验数量======================
  //SAP401
  //String sapUrl = "http://gfzcrmtest.wanmaco.com/gfzcrm/gfzCrmToSap/gfzCrmToSap?_APP_=m&_SK_=4b5b55ba23c422d9ab5b8649e27fb955";
  //SAP800
  String sapUrl = "http://gfzcrm.wanmagroup.com/gfzcrm/gfzCrmToSap/gfzCrmToSap?_APP_=m&_SK_=4b5b55ba23c422d9ab5b8649e27fb955";

  List sapDetailDataIds = [];
  Map sapResultMap = [:]
  Map sapHeader = [:]
  sapHeader.put("Content-Type", "application/json");
  Map sapParams = [:]
  
  //401参数
  //sapParams.put("urlheader",  "http"+"://wmsapqas.wanmagroup.com:8000")
  //sapParams.put("mandt", "401")
  //sapParams.put("flowType", "fhxqfortest")

  sapParams.put("oastatus", "")
  sapParams.put("flowType", "fhxq")
  //params.put("flowType", "fhxq")
  Map sapHeaderdata = ["headerdata":sapList]
  sapParams.put("jsonData", sapHeaderdata)
  log.info("params:"+Fx.json.toJson(sapParams))
  def (Boolean errorSAP,HttpResult httpResultSAP,String errorMessageSAP) =  Fx.http.post(sapUrl,sapHeader,sapParams,30000,false,0)
  
  log.info("POST结果error:"+errorSAP)
  log.info("POST结果errorMessage:"+errorMessageSAP)
  log.info("POST结果httpResult:"+httpResultSAP)
  
  if(errorSAP){
    log.info("发送http请求出错...")
    Fx.message.throwErrorMessage("发送http请求出错！"+errorMessageSAP);
  }
  if(httpResultSAP!=null && 200==httpResultSAP["statusCode"]){
    Map sapContent=httpResultSAP["content"] as Map;
    List sapMsg = sapContent["errMsg"] as List
    String sapCode= sapContent["errCode"]
    if(!sapCode.contains("s106240000")){
      Fx.message.throwErrorMessage("调用接口出错！错误码:"+ sapCode);
    }
    //遍历返回的参数集,如有某条发货需求校验失败,返回错误
    //更具返回值更新CRM单据信息
    sapMsg.each{
      it->
      sapDetailDataIds.add(it["pmkey"])
      reqid = it["reqid"]
    }
    if(reqid != null && reqid != ""){
       //=============修改主键========================
    //通过APIName,以及name主键查找对象
    def (Boolean error11,QueryResult data11,String errorMessage11) =Fx.object.find("object_tkC51__c",[["name":masterFieldVal["name"]]],10,0); 
    log.info("通过name查找对象"+data11)
    List id11=data11["dataList"]["_id"] as List
    id22=id11.get(0)
    // String id2 = masterFieldVal["_id"]
    log.info("id:"+id22)
    //update函数
    def (Boolean error22,Map data22,String errorMessage22)=Fx.object.update("object_tkC51__c",id22,["name":reqid,"field_2UEyD__c":reqid],false)//提交状态更新为提交成功 OA表单ID更新为返回表单单据
    //=================================================
    
    // //==================自定义函数添加映射关系========================
    Map header=[:]
    //创建数据映射
    Map param1=["ployDetailId":"22b4d9dd456e45af880015d715789300",//策略明细id（见下图），如果策略被删除重新建了，这里需要改动
    "sourceObjectApiName":"object_tkC51__c",//源对象apiName，如果对象apiName变了，这里要改动
    "destObjectApiName":"fhxq_1fdcs1v64",//目标对象apiName，如果对象apiName变了，这里要改动
    "sourceDataId":id22,//源对象数据id
    "destDataId":reqid,//目标对象数据id 
    "sourceDataName":reqid,//源对象数据name属性
    "destDataName":reqid,//目标对象数据name属性
    "remark":"自定义函数新建映射关系"];//备注
    def result1=Fx.proxy.callAPI("erp.syncData.createSyncDataMapping",header,param1);
    //[false, HttpResult(statusCode=200, content={"errCode":"s106240000","errMsg":"成功"}, bytes=null), ]   s106240000成功，其他失败
    log.info(result1)
  
  //================================================================
    }
   
   // Map updatedata = Maps.newHashMap();

    sapMsg.eachWithIndex{ item,int index->
      Map itemmap = [:]
      Map item1=item as Map
      itemmap.put("field_C31rS__c",  item1["status"])
      //itemmap.put("field_1bgjT__c",  item1["jjbj"])
      itemmap.put("field_091mM__c",  item1["sqbz"])
      itemmap.put("field_m9LJW__c", item1["fksm"])
      String matvbeln = item1["vbeln"] as String 
      String matposnr =  item1["posnr"] as String 
     
      log.info("key = " + matvbeln)
      //按照id更新明细表哦,字段
      String id = mxid[matvbeln.concat(matposnr)]
      //通过APIName,以及name主键查找对象
      def (Boolean error1,QueryResult data,String errorMessage1) =Fx.object.find("object_eyUri__c",[["name":id]],10,0); 
      log.info("通过name查找对象"+data)
      List id1=data["dataList"]["_id"] as List
      String id2=id1.get(0)
      def (Boolean error4,Map data4,String errorMessage4) =  Fx.object.update("object_eyUri__c",id2,itemmap,false)
      log.info("id = " + id)
      log.info("data2 = " + data4)
      log.info("error2 = " + error4)
      log.info("errorMessage2 = " + errorMessage4)
      log.info("itemmap = " + itemmap)
           
      //======================自定义函数添加子表映射关系============================================
      
      String pmkey = item1["pmkey"]
      Map header2=[:]
      //创建数据映射
      Map param2=["ployDetailId":"22b4d9dd456e45af880015d715789300",//策略明细id，如果策略被删除重新建了，这里需要改动
      "sourceObjectApiName":"object_eyUri__c",//源对象apiName，如果对象apiName变了，这里要改动
      "destObjectApiName":"fhxq_1fdcs1v6g",//目标对象apiName，如果对象apiName变了，这里要改动
      "sourceDataId":id2,//源对象数据id _id
      "destDataId":pmkey,//目标对象数据id pmkey
      "sourceDataName":data4["name"],//源对象数据name属性
      "destDataName":data4["name"],//目标对象数据name属性
      "masterDataId":id22,//从对像时，该字段必填。填写原数据主对象Id
      "remark":"自定义函数创建中间表"];//备注
      def result2=Fx.proxy.callAPI("erp.syncData.createSyncDataMapping",header2,param2);
      //[false, HttpResult(statusCode=200, content={"errCode":"s106240000","errMsg":"成功"}, bytes=null), ] s106240000成功，其他失败
      log.info(result2)
      //==================================================================

      
      reqid = item1["reqid"]
      if("X" == item1["jjbj"]){
        item1.put("field_6P5mj__c",  item1["vbeln"])
        item1.put("field_z4qql__c",  item1["posnr"])
        item1.put("field_Dq97B__c",mat[matvbeln.concat(matposnr)])
        item1.put("field_vb4Zq__c",  item1["lfimg"])
        item1.put("field_Wloz5__c",  item1["edatu"])
        item1.put("field_091mM__c",  item1["sqbz"])
        item1.put("name", data4["name"])
        list.add(item)
      }

    }
   
    log.info("sapDetailDataIds:"+sapDetailDataIds)
    Map sapDetailMap = ["fhxqmx":sapDetailDataIds]
    //sapResultMap.put("masterDataId",masterFieldVal["number"])
    sapResultMap.put("detailDataIds",sapDetailMap)
    log.info("sapResultMap = " + sapResultMap)
  
  }
  //=============================================================
}
 

log.info("masterFieldVal = " + masterFieldVal)

log.info("details list = " + list)
String qqTime = detailField[0]["field_Wloz5__c"]
masterFieldVal.put("name",  reqid)
log.info("qqTime = " +qqTime)
log.info(Date.of(qqTime))


//发起加急发货流程
if( list != null){//cus_name.contains("删除") &&
  if(list.size()>0){
  log.info("请求时间大于" + (Date.of(qqTime) - now))
 
  Map params = [:]
  //测试服流程编号
  //params.put("flowType",  "20000353")
  params.put("flowType",  "20000382")
  params.put("applyUser",  masterFieldVal["owner"])
  masterFieldVal.put("title", "加急发货需求-" +reqid)
  
  Map hearderdata = ["headerdata":masterFieldVal,"dtdata":list]
  params.put("jsonData", hearderdata)
  log.info("params= " + Fx.json.toJson(params))
  
  
  Map  header = [:]
  header.put("Content-Type",  "application/json")
  def (Boolean error,HttpResult httpResult,String errorMessage) =  Fx.http.post(url,header,params,30000,false,0)
  log.info("error: "+error)
  log.info("errorMessage: "+errorMessage)
  log.info("httpResult: "+httpResult)
  
  Map resultMap = [:]
  Map addDetail=["object_fhxqmx":Ids]//object_zkCE8__c
  if(error){
    log.info("发送http请求出错...")
    Fx.message.throwErrorMessage("发送http请求出错！"+errorMessage);
  }
  log.info("httpResult" + httpResult)
  
  if(httpResult!=null && 200==httpResult["statusCode"]){
    Map content=httpResult["content"] as Map; 
    String msg = content["errMsg"]
    String code= content["errCode"]
    resultMap.put("code",code)
    resultMap.put("message",msg)
    
    resultMap.put("data",["masterDataId":masterFieldVal["name"],"detailDataIds":addDetail])
  // resultMap.put("masterDataId",masterFieldVal["name"])
  // resultMap.put("detailDataIds",addDetail)

    if(code.contains("s106240000") && !msg.contains("-")) {//errMsg错误时会返回""-11:流程重复发起",这种情况也代表错误
      def (Boolean error2,Map data1,String errorMessage2)=Fx.object.update("object_tkC51__c",id22,["field_cQsba__c":msg,"field_sRvmD__c":"6"],false)//提交状态更新为提交成功 OA表单ID更新为返回表单单据
      log.info("加入表单ID后:"+data1 + errorMessage2 + error2+ id22+reqid)
      log.info("reqid = " +  reqid)
    }
    else {
      def (Boolean error2,Map data1,String errorMessage2)=Fx.object.update("object_tkC51__c",id22,["field_sRvmD__c":"5"],false)//提交状态更新为提交失败
      log.info("提交失败,单据未能成功提交！错误信息："+msg)
      Fx.message.throwErrorMessage("提交OA失败！OA返回结果为:"+msg);
    }
  }
  else{
      def (Boolean error2,Map data1,String errorMessage2)=Fx.object.update("object_tkC51__c",id22,["field_sRvmD__c":"5"],false)//提交状态更新为提交失败
      log.info("发送http请求失败...")
      Fx.message.throwErrorMessage("发送http请求失败");
  }
    
   log.info("resultMap" + resultMap)
   return resultMap
  }else{
  return null
  }
}else{
 return null;
}


```



